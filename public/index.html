<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarans dreamFarm</title>
    <link rel="stylesheet" href="index.css">
</head>


<body>
    <button id="openModalButton">Registrer deg</button>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Login</h2>
            Navn: <input type="text" id="registerName"><br>
            Email: <input type="text" id="registerEmail"><br>
            Passord: <input type="password" id="registerPassword"><br>
            <button id="createUserButton">Create User</button>
        </div>
    </div>

    <div id="petSelectionModal" class="modal">
        <div class="modal-content">
            <span class="closePetSelection">&times;</span>
            <h2>Choose Your Pet</h2>
            <div id="petOptions">
                <img src="media/Cat.png" alt="Cat" class="petOption" data-pet-type="cat">
                <img src="media/Dog.png" alt="Dog" class="petOption" data-pet-type="dog">
                <img src="media/Squirrel.png" alt="Squirrel" class="petOption" data-pet-type="squirrel">
                <img src="media/Deer.png" alt="Deer" class="petOption" data-pet-type="deer">
            </div>
            <label for="petname">Pet's Name:</label>
            <input type="text" id="petname" name="petname">
            <button id="registerPetButton">Register Pet</button>
        </div>
    </div>

    <button id="openLoginModalButton">Logg inn</button>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="closeLogin">&times;</span>
            <h2>Login</h2>
            Email: <input type="text" id="loginEmail"><br>
            Password: <input type="password" id="loginPassword"><br>
            <button id="loginButton">Logg inn</button>
        </div>
    </div>

    <div id="petDisplayArea"></div>

    <img id="startPageImage" src="media/TaransDreamFarm.png" alt="Tarans Dream Farm">

    <button id="myInfoButton" class="my-info-button">My Info</button>
    
    <!-- My Info Modal -->
    <div id="myInfoModal" class="modal"> <!-- Changed ID from loginModal to myInfoModal -->
        <div class="modal-content">
            <span class="closeMyInfo">&times;</span>
            <h2>My Info</h2>
            <p id="userInfoName">Name: </p>
            <p id="userInfoEmail">Email: </p>
            <p id="userPetName">Pet Name: </p>
            <!-- Your inputs and button for updating info -->
            <input type="text" id="updateName" placeholder="New Name">
            <input type="email" id="updateEmail" placeholder="New Email">
            <input type="password" id="updatePassword" placeholder="New Password">
            <button id="submitUpdate">Update Info</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const registerBtn = document.getElementById("openModalButton");
    const loginBtn = document.getElementById("openLoginModalButton");
    const registerModal = document.getElementById("registerModal");
    const loginModal = document.getElementById("loginModal");
    const petSelectionModal = document.getElementById("petSelectionModal");
    const spanCloseRegister = document.querySelector(".close");
    const spanCloseLogin = document.querySelector(".closeLogin");
    const spanClosePetSelection = document.querySelector(".closePetSelection");
    const petOptions = document.querySelectorAll('.petOption');
    const myInfoBtn = document.getElementById("myInfoButton");
    const myInfoModal = document.getElementById("myInfoModal");
    const spanCloseMyInfo = document.querySelector(".closeMyInfo");


    let selectedPetType


    // Function to hide all modals
    const hideAllModals = () => {
        registerModal.style.display = "none";
        loginModal.style.display = "none";
        petSelectionModal.style.display = "none";
    };

    // Open modals
    registerBtn.onclick = () => registerModal.style.display = "block";
    loginBtn.onclick = () => loginModal.style.display = "block";

    // Close buttons
    spanCloseRegister.onclick = () => registerModal.style.display = "none";
    spanCloseLogin.onclick = () => loginModal.style.display = "none";
    spanClosePetSelection.onclick = () => petSelectionModal.style.display = "none";

    // Click outside to close
    window.onclick = event => {
        if (event.target === registerModal || event.target === loginModal || event.target === petSelectionModal) {
            hideAllModals();
        }
    };

    if (myInfoBtn) {
        myInfoBtn.addEventListener("click", () => {
            myInfoModal.style.display = "block";
        });
    }

    // Add event listener to the close button of My Info Modal if it exists
    if (spanCloseMyInfo) {
        spanCloseMyInfo.addEventListener("click", () => {
            myInfoModal.style.display = "none";
        });
    }



    // Handle user registration
    document.getElementById("createUserButton").addEventListener("click", async (event) => {
    event.preventDefault();

        const name = document.getElementById("registerName").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        console.log("Attempting to register user", { name, email, password });

        try {
            const response = await fetch('http://localhost:8080/user/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, email, password })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const userData = await response.json();
        console.log("User registered successfully", userData);
        alert("User registered successfully. Now choose your pet.");

        // Store user ID for pet registration
        localStorage.setItem('userId', userData.id);

        // Hide user registration modal and show pet selection modal
        document.getElementById("registerModal").style.display = "none";
        document.getElementById("petSelectionModal").style.display = "block";
    } catch (error) {
        console.error("Error during user registration:", error);
        alert("An error occurred during registration. Please try again.");
    }
    });

    //Pet selection inside the modal
        petOptions.forEach(option => {
        option.addEventListener('click', (event) => {
        petOptions.forEach(opt => opt.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        selectedPetType = event.currentTarget.getAttribute('data-pet-type');
        localStorage.setItem('selectedPetType', selectedPetType);
        });
    }); 


    //Pet registration

    document.getElementById("registerPetButton").addEventListener("click", async () => {
    const petName = document.getElementById("petname").value;
    const selectedPetType = localStorage.getItem('selectedPetType');
    // Retrieve the stored token for authentication
    const authToken = localStorage.getItem('authToken');

    if (!authToken) {
        console.error("No authentication token found. Please log in.");
        alert("Please log in to register a pet.");
        return; // Stop execution if there's no authToken
    }

    try {
        const response = await fetch('http://localhost:8080/pets/registerPet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Basic ${authToken}` // Include the auth token in the request
            },
            body: JSON.stringify({
                petType: selectedPetType,
                petName,
            }),
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        console.log("Pet registered successfully");
        alert("Pet registered successfully.");

        // UI update after successful registration
        const taransDreamFarmImage = document.getElementById("startPageImage");
        if (taransDreamFarmImage) {
            taransDreamFarmImage.style.display = "none";
        }

        const petDisplayArea = document.getElementById("petDisplayArea");
        petDisplayArea.innerHTML = '';

        const petImg = document.createElement("img");
        const petTypeToImageSrcMap = {
            cat: "media/Cat.png",
            dog: "media/Dog.png",
            squirrel: "media/Squirrel.png",
            deer: "media/Deer.png",
        };
        petImg.src = petTypeToImageSrcMap[selectedPetType];
        petImg.alt = selectedPetType;
        petImg.classList.add("pet-image");

        const petNameElement = document.createElement("p");
        petNameElement.textContent = petName;
        petNameElement.classList.add("pet-name");

        petDisplayArea.appendChild(petImg);
        petDisplayArea.appendChild(petNameElement);

        // Hide the pet selection modal
        document.getElementById("petSelectionModal").style.display = "none";

    } catch (error) {
        console.error("Error during pet registration:", error);
        alert("Failed to register pet. Please try again.");
    }
});


    // My Info Modal
    document.getElementById("submitUpdate").addEventListener("click", async () => {
    const userId = localStorage.getItem('userId'); // Ensure this is correctly stored during login
    const name = document.getElementById("updateName").value;
    const email = document.getElementById("updateEmail").value;
    const password = document.getElementById("updatePassword").value;

    try {
        const response = await fetch(`http://localhost:8080/user/${userId}`, { // Make sure the URL matches your API
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, email, password }),
        });

        if (response.ok) {
            const updatedUserData = await response.json(); // Assuming your API returns the updated user data
            console.log("User info updated successfully", updatedUserData);
            alert("User info updated successfully.");
            // Call displayPetAndUserInfo or other UI update functions here with the updatedUserData
            // displayPetAndUserInfo(updatedUserData);
        } else {
            console.error("Failed to update user info");
            alert("Failed to update user info.");
        }
    } catch (error) {
        console.error('Error:', error);
        alert("An error occurred. Please try again.");
    }
});

// Define displayPetAndUserInfo function outside the event listener
function displayPetAndUserInfo(userData) {
    // Update the UI with userData
    const userInfoArea = document.getElementById("userInfo"); // Make sure this element exists
    if (userInfoArea) {
        userInfoArea.textContent = `Welcome, ${userData.name}!`; // Customize as needed
    }
    // Update pet info similarly
}


    //Login
 
    const loginButton = document.getElementById("loginButton");
if (loginButton) {
    loginButton.addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
            const response = await fetch('http://localhost:8080/user/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) {
    throw new Error(`Login failed: ${response.statusText}`);
}

const userData = await response.json();
console.log("Login successful", userData);

const token = btoa(email + ":" + password); // Base64 encode email and password
localStorage.setItem('authToken', token); // Store it for later use

document.getElementById("loginModal").style.display = "none";
document.getElementById("startPageImage").style.display = "none";

fetchAndDisplayUserPets(); // Call this function here

            // Assuming pet data is correctly included in the response and you want to display the first pet
            const petData = userData.pet[0]; // Adjust based on actual response structure
            if (petData) {
                displayPet(petData.pet_name, petData.pet_type); // Assuming your pet object includes 'pet_name' and 'pet_type'
            } else {
                console.log("No pet data available for this user.");
            }
        } catch (error) {
            console.error("Login error:", error);
            alert("Login failed, please try again.");
        }
    });
} else {
    console.error("Element with ID 'loginButton' not found.");
}

// Fetch protected user info
async function fetchProtectedUserInfo() {
    const authToken = localStorage.getItem('authToken'); // Retrieve the stored token
    if (!authToken) {
        console.error("No authentication token found. Please log in.");
        return;
    }

    try {
        const response = await fetch('http://localhost:8080/user/protected-user-info', {
            headers: {
                'Authorization': `Basic ${authToken}`, // Include the token in the Authorization header
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch protected user info: ${response.statusText}`);
        }

        const userData = await response.json();
        console.log("Protected user info:", userData);
        // Process the userData as needed
    } catch (error) {
        console.error("Error fetching protected user info:", error);
    }
}


async function fetchAndDisplayUserPets() {
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        console.error("No authentication token found. Please log in.");
        return;
    }

    try {
        const response = await fetch('http://localhost:8080/pets/user-pets', {
            method: 'GET',
            headers: {
                'Authorization': `Basic ${authToken}`,
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch user's pets: ${response.statusText}`);
        }

        const petsData = await response.json();
        console.log("User's pets fetched successfully", petsData);

        displayPets(petsData); // Use the revised function to display all fetched pets
    } catch (error) {
        console.error("Error fetching user's pets:", error);
        }
    }
});

document.addEventListener('DOMContentLoaded', () => {
    // Your existing DOMContentLoaded logic here
    // Ensure fetchAndDisplayUserPets() is called after a successful login

    const loginButton = document.getElementById("loginButton");
    if (loginButton) {
        loginButton.addEventListener("click", async () => {
            // Your login logic here

            // After successful login, call fetchAndDisplayUserPets
            fetchAndDisplayUserPets();
        });
    }
});


// Revised display function to handle multiple pets
function displayPet(petName, petType) {
    const petDisplayArea = document.getElementById("petDisplayArea");
    const petTypeToImageSrcMap = {
        cat: "media/Cat.png",
        dog: "media/Dog.png",
        squirrel: "media/Squirrel.png",
        deer: "media/Deer.png",
    };

    // Create and append the image element for the pet
    const petImg = document.createElement("img");
    petImg.src = petTypeToImageSrcMap[petType]; // Use the correct parameter here
    petImg.alt = petType;
    petImg.classList.add("pet-image");
    petDisplayArea.appendChild(petImg);

    // Create and append the text element for the pet's name
    const petNameElement = document.createElement("p");
    petNameElement.textContent = petName; // Use the correct parameter here
    petNameElement.classList.add("pet-name");
    petDisplayArea.appendChild(petNameElement);
}

    function displayPets(petsData) {
    const petDisplayArea = document.getElementById("petDisplayArea");
    petDisplayArea.innerHTML = ''; // Clear previous content
    petsData.forEach(pet => {
        // Assuming your API sends 'pet_name' and 'pet_type', adjust if necessary
        displayPet(pet.pet_name, pet.pet_type);
    });
}
    

// fetchAndDisplayUserPets remains mostly the same
async function fetchAndDisplayUserPets() {
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        console.error("No authentication token found. Please log in.");
        return;
    }

    try {
        const response = await fetch('http://localhost:8080/pets/user-pets', {
            method: 'GET',
            headers: {
                'Authorization': `Basic ${authToken}`,
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch user's pets: ${response.statusText}`);
        }

        const petsData = await response.json();
        console.log("User's pets fetched successfully", petsData);

        displayPets(petsData); // Use the revised function to display all fetched pets
    } catch (error) {
        console.error("Error fetching user's pets:", error);
        }
    }


document.addEventListener('DOMContentLoaded', () => {
    // Your existing DOMContentLoaded logic here
    // Ensure fetchAndDisplayUserPets() is called after a successful login

    const loginButton = document.getElementById("loginButton");
    if (loginButton) {
        loginButton.addEventListener("click", async () => {
            // Your login logic here

            // After successful login, call fetchAndDisplayUserPets
            fetchAndDisplayUserPets();
        });
    }
});


</script>
     </body>
         </html>